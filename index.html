<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Brain Dump AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { 
            background-color: #020617; /* bg-slate-950 */
            color: #f8fafc; /* text-slate-50 */
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            -webkit-tap-highlight-color: transparent; 
        }
        ::-webkit-scrollbar { display: none; }
        .glass-header {
            background: rgba(2, 6, 23, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const API_VERSION = "v1beta";

        // カテゴリーごとの色定義
        const CATEGORY_COLORS = {
            "Work": "bg-blue-500",      // 仕事
            "Life": "bg-emerald-500",   // 生活
            "Idea": "bg-amber-400",     // アイデア
            "Hobby": "bg-purple-500",   // 趣味
            "Learn": "bg-pink-500",     // 学習
            "Other": "bg-slate-500"     // その他
        };

        const App = () => {
            // --- State ---
            const [hasKey, setHasKey] = useState(() => !!localStorage.getItem("gemini_api_key_brain"));
            const [apiKey, setApiKey] = useState(() => localStorage.getItem("gemini_api_key_brain") || "");
            const [memos, setMemos] = useState(() => JSON.parse(localStorage.getItem("brain_dump_memos") || "[]"));
            const [inputText, setInputText] = useState("");
            const [isProcessing, setIsProcessing] = useState(false);
            const [availableModels, setAvailableModels] = useState([]);
            const [selectedModel, setSelectedModel] = useState(() => localStorage.getItem("brain_selected_model") || "");

            const messagesEndRef = useRef(null);

            // --- Effects ---
            useEffect(() => {
                localStorage.setItem("brain_dump_memos", JSON.stringify(memos));
            }, [memos]);

            useEffect(() => {
                if (hasKey && apiKey) fetchModels(apiKey);
            }, [hasKey]);

            // --- Logic ---
            const fetchModels = async (key) => {
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/${API_VERSION}/models?key=${key}`);
                    const data = await res.json();
                    if (!res.ok) return;
                    
                    const models = data.models
                        .filter(m => m.supportedGenerationMethods.includes("generateContent"))
                        .map(m => m.name.replace("models/", ""))
                        .sort();
                    
                    setAvailableModels(models);
                    if (!selectedModel && models.length > 0) {
                        // 賢いモデル優先
                        const best = models.find(m => m.includes("27b")) || models.find(m => m.includes("12b")) || models[0];
                        setSelectedModel(best);
                        localStorage.setItem("brain_selected_model", best);
                    }
                } catch (e) { console.error(e); }
            };

            const processMemoWithAI = async (text) => {
                const target = selectedModel || "gemma-3-12b-it";
                const url = `https://generativelanguage.googleapis.com/${API_VERSION}/models/${target}:generateContent?key=${apiKey}`;

                const prompt = `
あなたは優秀なメモ整理アシスタントです。ユーザーの入力テキストを分析し、以下のJSON形式で分類・要約してください。

【入力テキスト】
${text}

【出力ルール】
1. JSONのみ出力すること。
2. "title": 15文字以内の簡潔なタイトル（日本語）。
3. "category": 次の中から1つ選択 [Work, Life, Idea, Hobby, Learn, Other]。
4. "tags": 関連するタグを2つまで（日本語可、#は不要）。

【JSON例】
{"title": "買い物リスト", "category": "Life", "tags": ["スーパー", "夕食"]}
`;

                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error?.message);

                    const rawText = data.candidates[0].content.parts[0].text;
                    const jsonStr = rawText.replace(/```json|```/g, "").trim();
                    return JSON.parse(jsonStr);

                } catch (e) {
                    console.error("AI Error:", e);
                    // エラー時はフォールバック（AIなしで保存）
                    return {
                        title: text.slice(0, 15) + "...",
                        category: "Other",
                        tags: ["未分類"]
                    };
                }
            };

            const handleSend = async () => {
                if (!inputText.trim() || isProcessing) return;
                
                const rawText = inputText;
                setInputText(""); // 先に入力をクリアして快適に
                setIsProcessing(true);

                // 仮のメモを表示（UX向上）
                const tempId = Date.now();
                /*
                setMemos(prev => [{
                    id: tempId,
                    text: rawText,
                    title: "AI解析中...",
                    category: "Other",
                    tags: [],
                    timestamp: new Date().toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'}),
                    isTemp: true
                }, ...prev]);
                */

                // AI処理
                const analyzed = await processMemoWithAI(rawText);
                
                const newMemo = {
                    id: Date.now(),
                    text: rawText,
                    title: analyzed.title,
                    category: analyzed.category,
                    tags: analyzed.tags,
                    timestamp: new Date().toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'}),
                    dateFull: new Date().toLocaleDateString('ja-JP'),
                };

                setMemos(prev => [newMemo, ...prev]); // 先頭に追加
                setIsProcessing(false);
            };

            const deleteMemo = (id) => {
                if(confirm("削除しますか？")) setMemos(prev => prev.filter(m => m.id !== id));
            };

            // --- Render: Login ---
            if (!hasKey) return (
                <div className="h-screen bg-slate-950 flex flex-col items-center justify-center p-6 text-slate-50">
                    <div className="w-16 h-16 bg-slate-800 rounded-2xl flex items-center justify-center mb-6 border border-slate-700">
                        <i data-lucide="brain-circuit" className="w-8 h-8 text-teal-400"></i>
                    </div>
                    <h1 className="text-2xl font-bold mb-2">Brain Dump</h1>
                    <p className="text-slate-400 text-sm mb-8 text-center">思考を投げ込むだけで、AIが整理整頓。<br/>APIキーを入力して開始。</p>
                    <input 
                        type="text" 
                        value={apiKey} 
                        onChange={e=>setApiKey(e.target.value)} 
                        placeholder="Gemini API Key" 
                        className="w-full p-4 rounded-xl bg-slate-900 border border-slate-800 mb-4 text-white outline-none focus:border-teal-500 transition-colors"
                    />
                    <button 
                        onClick={()=> {
                            if(apiKey.length < 10) return alert("キーが短すぎます");
                            localStorage.setItem("gemini_api_key_brain", apiKey);
                            setHasKey(true);
                            fetchModels(apiKey);
                        }} 
                        className="w-full bg-teal-600 hover:bg-teal-500 py-4 rounded-xl font-bold text-white transition-all active:scale-95"
                    >
                        ロック解除
                    </button>
                </div>
            );

            // --- Render: Main App ---
            return (
                <div className="h-[100dvh] w-full flex flex-col bg-slate-950 relative overflow-hidden">
                    
                    {/* Header */}
                    <header className="glass-header h-14 border-b border-slate-800 flex justify-between items-center px-4 absolute top-0 w-full z-20">
                        <div className="flex items-center gap-2">
                            <i data-lucide="brain-circuit" className="w-5 h-5 text-teal-400"></i>
                            <h1 className="font-bold text-lg tracking-tight">Brain Dump</h1>
                        </div>
                        <div className="flex gap-4">
                            <button className="text-slate-400 hover:text-white transition-colors"><i data-lucide="search" className="w-5 h-5"></i></button>
                            <div className="relative group">
                                <i data-lucide="settings-2" className="w-5 h-5 text-slate-400 group-hover:text-white transition-colors"></i>
                                <select 
                                    onChange={e => {setSelectedModel(e.target.value); localStorage.setItem("brain_selected_model", e.target.value);}} 
                                    value={selectedModel} 
                                    className="absolute inset-0 opacity-0 w-full h-full cursor-pointer"
                                >
                                    {availableModels.length > 0 ? availableModels.map(m => <option key={m} value={m}>{m}</option>) : <option>モデル読込中...</option>}
                                </select>
                            </div>
                        </div>
                    </header>

                    {/* Memo List */}
                    <main className="flex-1 overflow-y-auto pt-14 pb-20 w-full">
                        {memos.length === 0 ? (
                            <div className="h-full flex flex-col items-center justify-center text-slate-600 gap-4 opacity-50">
                                <i data-lucide="wind" className="w-12 h-12"></i>
                                <p className="text-sm">頭の中を空っぽにしよう</p>
                            </div>
                        ) : (
                            <div className="flex flex-col">
                                {memos.map((memo) => {
                                    const barColor = CATEGORY_COLORS[memo.category] || "bg-slate-500";
                                    return (
                                        <div key={memo.id} className="relative pl-5 pr-4 py-4 border-b border-slate-800/50 hover:bg-slate-900/50 transition-colors group">
                                            {/* Colored Strip */}
                                            <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${barColor}`}></div>
                                            
                                            <div className="flex justify-between items-start mb-1">
                                                <h3 className="font-bold text-slate-100 text-base leading-tight">{memo.title}</h3>
                                                <span className="text-[10px] text-slate-500 font-mono pt-1">{memo.timestamp}</span>
                                            </div>
                                            
                                            <p className="text-slate-400 text-sm line-clamp-2 mb-3 leading-relaxed opacity-90">
                                                {memo.text}
                                            </p>
                                            
                                            <div className="flex justify-between items-center">
                                                <div className="flex gap-2">
                                                    {memo.tags.map(tag => (
                                                        <span key={tag} className="text-[10px] px-2 py-0.5 rounded-full bg-slate-800 text-slate-300 border border-slate-700">
                                                            #{tag}
                                                        </span>
                                                    ))}
                                                </div>
                                                <button onClick={() => deleteMemo(memo.id)} className="opacity-0 group-hover:opacity-100 text-slate-600 hover:text-red-400 transition-opacity p-1">
                                                    <i data-lucide="trash-2" className="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </main>

                    {/* Input Area */}
                    <div className="absolute bottom-0 w-full bg-slate-950 border-t border-slate-800 p-3 pb-safe z-30">
                        <div className="relative flex items-end gap-2 bg-slate-900 rounded-2xl border border-slate-800 p-1 focus-within:border-teal-500/50 transition-colors shadow-lg shadow-black/50">
                            <textarea 
                                value={inputText}
                                onChange={(e) => setInputText(e.target.value)}
                                onKeyDown={(e) => {
                                    if(e.key === 'Enter' && (e.metaKey || e.ctrlKey)) handleSend();
                                }}
                                placeholder="頭の中を書き出す..." 
                                className="w-full bg-transparent text-slate-200 text-sm p-3 outline-none resize-none max-h-32 min-h-[48px] placeholder:text-slate-600"
                                rows="1"
                            />
                            <button 
                                onClick={handleSend} 
                                disabled={isProcessing || !inputText.trim()}
                                className={`p-3 rounded-xl mb-0.5 transition-all ${
                                    inputText.trim() 
                                    ? 'bg-teal-600 text-white shadow-lg shadow-teal-900/20 active:scale-95' 
                                    : 'bg-slate-800 text-slate-500 cursor-not-allowed'
                                }`}
                            >
                                {isProcessing ? (
                                    <i data-lucide="loader-2" className="w-5 h-5 animate-spin"></i>
                                ) : (
                                    <i data-lucide="arrow-up" className="w-5 h-5"></i>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
